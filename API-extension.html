<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI Summaries - New Programs</title>
    <style>
        body {
            font-family: 'Avenir Medium', 'Avenir', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: white;
            min-height: 100vh;
            overflow-y: scroll;
        }
        
        .container {
            width: 100%;
            max-width: 1392px;
            margin: 0 auto;
            background: white;
            padding: 0;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px 0 10px 0;
        }
        
        .title {
            font-size: 28px;
            font-weight: 700;
            color: #03304D;
            margin: 0 0 20px 0;
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
            text-align: center;
        }
        
        .prompt-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 0;
            flex-wrap: wrap;
        }
        
        .prompt-btn {
            background: #eff9fe;
            color: #03304D;
            border: 1px solid #03304D;
            padding: 10px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-family: "Avenir Medium", "Avenir", "Avenir Next", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        .prompt-btn:hover {
            background: #d0e8f4;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .prompt-btn.active {
            background: #024a73;
            color: white;
            border-color: #024a73;
        }
        
        .prompt-btn.active:hover {
            background: #1976d2;
            border-color: #1976d2;
        }
        
        .summary-container {
            border-top: 1px solid #dee2e6;
            margin-top: 0;
        }
        
        .program-title {
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
            font-size: 22px;
            font-weight: bold;
            color: #03304d;
            margin: 20px 0 15px 0;
            text-align: left;
        }
        
        .loading {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #e3f2fd;
            border-radius: 6px;
            color: #1976d2;
            font-weight: 500;
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
            border: 1px solid #bbdefb;
            margin: 16px 20px;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e3f2fd;
            border-top: 2px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .summary-text {
            background: white;
            padding: 20px;
            min-height: 200px;
            font-size: 18px;
            line-height: 1.8;
            color: #2c3e50;
            white-space: pre-wrap;
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
        }
        
        /* First line - lighter blue subtitle */
        .summary-text .subtitle {
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
            font-size: 18px;
            color: #1AB2D7 !important;
            margin-bottom: 25px;
            line-height: 1.6;
            display: inline-block;
        }
        
        .summary-text h1,
        .summary-text h2 {
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
            font-size: 32px;
            font-weight: bold;
            color: #03304D;
            margin: 15px 0 15px 0;
            line-height: 1.3;
        }
        
        .summary-text h3 {
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
            font-size: 28px;
            font-weight: bold;
            color: #03304D;
            margin: 25px 0 12px 0;
            line-height: 1.3;
        }
        
        .summary-text p {
            margin-bottom: 18px;
            line-height: 1.8;
        }
        
        .summary-text ul {
            margin: 15px 0;
            padding-left: 25px;
        }
        
        .summary-text li {
            margin-bottom: 14px;
            line-height: 1.8;
            font-size: 17px;
        }
        
        /* Make subtitle/description text bold and larger */
        .summary-text p:nth-of-type(2),
        .summary-text p:first-child:not([style*="display: none"]) {
            font-weight: 900;
            font-size: 19px;
            color: #2c3e50;
            font-style: italic;
            margin-bottom: 20px;
        }
        
        .summary-text table {
            margin: 40px auto;
            border-collapse: collapse;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-text th,
        .summary-text td {
            border: 1px solid #03304D;
            padding: 12px 20px;
            text-align: center;
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
        }
        
        .summary-text th {
            background-color: #03304D;
            color: white;
            font-weight: bold;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-text td {
            background-color: #f8f9fa;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .summary-text tr:last-child td {
            background-color: #e8f4f8;
            font-weight: bold;
            font-size: 17px;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ffcdd2;
            margin: 16px 20px;
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
        }
        
        .institution-badge {
            display: inline-block;
            background: #03304D;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 14px;
            margin: 2px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title" id="mainTitle">AI Summaries - New Programs</h1>
            
            <div class="prompt-buttons">
                <button class="prompt-btn active" onclick="selectPrompt('newprogram', this)">New Program Summary</button>
                <button class="prompt-btn" onclick="selectPrompt('top20', this)">Top 20 New Programs</button>
                <button class="prompt-btn" onclick="selectPrompt('innovations', this)">Curricular Innovations</button>
                <button class="prompt-btn" onclick="selectPrompt('curriculum', this)">Sample Curriculum</button>
                <button class="prompt-btn" onclick="selectPrompt('pricing', this)">Pricing</button>
            </div>
        </div>
        
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <span>Analyzing data with AI...</span>
        </div>
        
        <div class="summary-container">
            <div class="summary-text" id="summaryText">
                Analysis will appear here when triggered.
            </div>
        </div>
        
        <div id="errorMessage" class="error" style="display: none;"></div>
    </div>

    <script>
        console.log('üöÄ AI Extension v2025.01.25 loaded');
        
        // API Configuration
        const GEMINI_API_URL = 'https://uq-solutions-gemini.vercel.app/api/gemini';
        const CLAUDE_API_URL = 'https://uq-solutions.vercel.app/api/claude';
        
        // Prompt URLs for different analysis types
        const PROMPT_URLS = {
            innovations: 'https://raw.githubusercontent.com/Lucas-Wisnieski/UQ-Solutions/main/prompts/innovations-summary-prompt.txt',
            pricing: 'https://raw.githubusercontent.com/Lucas-Wisnieski/UQ-Solutions/main/prompts/pricing-summary-prompt.txt',
            curriculum: 'https://raw.githubusercontent.com/Lucas-Wisnieski/UQ-Solutions/main/prompts/curriculum-summary-prompt.txt',
            newprogram: 'https://raw.githubusercontent.com/Lucas-Wisnieski/UQ-Solutions/main/prompts/ai-analysis-prompt.txt'
        };
        
        // GitHub Pages URLs for Tableau API
        const GITHUB_API_URLS = [
            'https://lucas-wisnieski.github.io/UQ-Solutions/js/tableau.extensions.1.latest.js',
            'https://lucas-wisnieski.github.io/UQ-Solutions/js/tableau.extensions.1.latest.min.js'
        ];

        // Global state
        let isProcessing = false;
        let isInitialized = false;
        let prompts = {
            innovations: null,
            pricing: null,
            curriculum: null,
            newprogram: null,
            top20: null
        };
        let currentPromptType = 'newprogram';
        let lastTriggerCheck = 0;

        // Check for triggers from external sources
        function checkForTriggers() {
            // Check for completed summary results (both Gemini and Claude)
            try {
                const geminiResult = localStorage.getItem('gemini-summary-result');
                if (geminiResult) {
                    const resultData = JSON.parse(geminiResult);
                    if (resultData.timestamp > lastTriggerCheck) {
                        localStorage.removeItem('gemini-summary-result');
                        lastTriggerCheck = Date.now();
                        displayExternalSummary(resultData.content, 'gemini');
                        return;
                    }
                }
                
                const claudeResult = localStorage.getItem('claude-summary-result');
                if (claudeResult) {
                    const resultData = JSON.parse(claudeResult);
                    if (resultData.timestamp > lastTriggerCheck) {
                        localStorage.removeItem('claude-summary-result');
                        lastTriggerCheck = Date.now();
                        displayExternalSummary(resultData.content, 'claude');
                        return;
                    }
                }
            } catch (e) {
                // Ignore localStorage errors
            }
            
            // Check Tableau settings for completed summary
            if (typeof tableau !== 'undefined' && tableau.extensions && tableau.extensions.settings) {
                try {
                    const geminisummaryContent = tableau.extensions.settings.get('gemini-summary-content');
                    const geminisummaryTimestamp = tableau.extensions.settings.get('gemini-summary-timestamp');
                    
                    if (geminisummaryContent && geminisummaryTimestamp && parseInt(geminisummaryTimestamp) > lastTriggerCheck) {
                        tableau.extensions.settings.set('gemini-summary-content', '');
                        tableau.extensions.settings.set('gemini-summary-timestamp', '');
                        lastTriggerCheck = Date.now();
                        displayExternalSummary(geminisummaryContent, 'gemini');
                        return;
                    }
                    
                    const claudeSummaryContent = tableau.extensions.settings.get('claude-summary-content');
                    const claudeSummaryTimestamp = tableau.extensions.settings.get('claude-summary-timestamp');
                    
                    if (claudeSummaryContent && claudeSummaryTimestamp && parseInt(claudeSummaryTimestamp) > lastTriggerCheck) {
                        tableau.extensions.settings.set('claude-summary-content', '');
                        tableau.extensions.settings.set('claude-summary-timestamp', '');
                        lastTriggerCheck = Date.now();
                        displayExternalSummary(claudeSummaryContent, 'claude');
                        return;
                    }
                } catch (e) {
                    // Ignore settings errors
                }
            }
            
            // Check for trigger signals
            try {
                const geminiTrigger = localStorage.getItem('gemini-summary-trigger');
                if (geminiTrigger) {
                    const triggerData = JSON.parse(geminiTrigger);
                    if (triggerData.timestamp > lastTriggerCheck) {
                        localStorage.removeItem('gemini-summary-trigger');
                        lastTriggerCheck = Date.now();
                        generateSummary();
                        return;
                    }
                }
                
                const claudeTrigger = localStorage.getItem('claude-summary-trigger');
                if (claudeTrigger) {
                    const triggerData = JSON.parse(claudeTrigger);
                    if (triggerData.timestamp > lastTriggerCheck) {
                        localStorage.removeItem('claude-summary-trigger');
                        lastTriggerCheck = Date.now();
                        currentPromptType = 'newprogram';
                        generateSummary();
                        return;
                    }
                }
            } catch (e) {
                // Ignore localStorage errors
            }
        }

        // Start polling for triggers
        setInterval(checkForTriggers, 500);

        // Message listener for trigger button communication
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'TRIGGER_GEMINI_SUMMARY') {
                lastTriggerCheck = Date.now();
                generateSummary();
            }
            else if (event.data && event.data.type === 'TRIGGER_CLAUDE_SUMMARY') {
                lastTriggerCheck = Date.now();
                currentPromptType = 'newprogram';
                generateSummary();
            }
            else if (event.data && event.data.type === 'DISPLAY_GEMINI_SUMMARY') {
                if (event.data.summary) {
                    displayExternalSummary(event.data.summary, 'gemini');
                }
            }
            else if (event.data && event.data.type === 'DISPLAY_CLAUDE_SUMMARY') {
                if (event.data.summary) {
                    displayExternalSummary(event.data.summary, 'claude');
                }
            }
        });

        console.log('‚úÖ AI extension message listener initialized');

        function displayExternalSummary(summaryText, source) {
            console.log(`üìã Displaying ${source} AI summary...`);
            
            let htmlSummary;
            
            if (source === 'claude') {
                htmlSummary = formatClaudeSummary(summaryText);
            } else {
                htmlSummary = formatGeminiSummary(summaryText);
            }
            
            document.getElementById('summaryText').innerHTML = htmlSummary;
            document.getElementById('loadingIndicator').style.display = 'none';
            hideError();
            
            console.log(`‚úÖ ${source} summary displayed successfully`);
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up AI extension...');
            
            try {
                loadPrompts();
            } catch (error) {
                console.error('Setup error:', error);
                showError('Extension setup failed: ' + error.message);
            }
        });

        function loadPrompts() {
            console.log('üîç Loading all AI prompts from GitHub...');
            
            // Load all prompts
            Promise.all([
                fetch(PROMPT_URLS.innovations).then(r => r.text()),
                fetch(PROMPT_URLS.pricing).then(r => r.text()),
                fetch(PROMPT_URLS.curriculum).then(r => r.text()),
                fetch(PROMPT_URLS.newprogram).then(r => r.text())
            ])
            .then(function([innovationsText, pricingText, curriculumText, newprogramText]) {
                prompts.innovations = innovationsText.trim();
                prompts.pricing = pricingText.trim();
                prompts.curriculum = curriculumText.trim();
                prompts.newprogram = newprogramText.trim();
                
                console.log('‚úÖ All prompts loaded:');
                console.log('- Innovations:', prompts.innovations.length, 'characters');
                console.log('- Pricing:', prompts.pricing.length, 'characters');
                console.log('- Curriculum:', prompts.curriculum.length, 'characters');
                console.log('- New Program:', prompts.newprogram.length, 'characters');
                
                loadTableauAPI();
            })
            .catch(function(error) {
                console.error('‚ùå Failed to load prompts:', error);
                showError('Failed to load analysis prompts: ' + error.message);
            });
        }

        function loadTableauAPI() {
            console.log('üîç Loading Tableau API...');
            
            if (typeof tableau !== 'undefined' && tableau.extensions) {
                console.log('‚úÖ Tableau API already available');
                initializeExtension();
                return;
            }

            const urls = [
                ...GITHUB_API_URLS,
                'https://raw.githubusercontent.com/tableau/extensions-api/master/lib/tableau.extensions.1.latest.js'
            ];

            let currentIndex = 0;

            function tryLoad() {
                if (currentIndex >= urls.length) {
                    console.log('‚ùå All API loading attempts failed');
                    return;
                }

                const url = urls[currentIndex];
                console.log(`üîÑ Trying: ${url}`);

                const script = document.createElement('script');
                script.src = url;
                
                script.onload = function() {
                    console.log(`‚úÖ Loaded from: ${url}`);
                    if (typeof tableau !== 'undefined' && tableau.extensions) {
                        initializeExtension();
                    }
                };
                
                script.onerror = function() {
                    console.log(`‚ùå Failed: ${url}`);
                    currentIndex++;
                    setTimeout(tryLoad, 100);
                };
                
                document.head.appendChild(script);
            }

            tryLoad();
        }

        function initializeExtension() {
            if (tableau && tableau.extensions) {
                // Handle context menu configuration
                const contextMenuCallbacks = {
                    'configure': function() {
                        console.log('Configure menu clicked');
                        // Add any configuration logic here if needed
                    }
                };
                
                tableau.extensions.initializeAsync({'configure': contextMenuCallbacks['configure']})
                    .then(function() {
                        console.log('üéâ AI extension initialized!');
                        isInitialized = true;
                        
                        // Auto-generate New Program Summary after initialization
                        setTimeout(function() {
                            console.log('üîÑ Auto-generating New Program Summary...');
                            selectPrompt('newprogram', document.querySelector('.prompt-btn.active'));
                        }, 200);
                    })
                    .catch(function(error) {
                        console.error('‚ùå Init failed:', error);
                        isInitialized = false;
                    });
            } else {
                console.log('‚ö†Ô∏è Tableau Extensions API not available');
                isInitialized = false;
            }
        }

        function selectPrompt(promptType, buttonElement) {
            console.log('üìã Selecting prompt type:', promptType);
            
            // Check if Top 20 New Programs is selected (no function yet)
            if (promptType === 'top20') {
                console.log('‚ö†Ô∏è Top 20 New Programs function not yet implemented');
                document.getElementById('summaryText').innerHTML = '<p style="color: #666; text-align: center; margin-top: 50px;">Top 20 New Programs analysis coming soon...</p>';
                document.getElementById('loadingIndicator').style.display = 'none';
                
                // Update button states
                document.querySelectorAll('.prompt-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                buttonElement.classList.add('active');
                
                // Update main title
                const mainTitle = document.getElementById('mainTitle');
                mainTitle.textContent = buttonElement.textContent + ' - New Programs';
                
                return;
            }
            
            // Update button states
            document.querySelectorAll('.prompt-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            buttonElement.classList.add('active');
            
            // Update main title with button text
            const mainTitle = document.getElementById('mainTitle');
            mainTitle.textContent = buttonElement.textContent + ' - New Programs';
            
            // Update current prompt type
            currentPromptType = promptType;
            
            // Update loading message based on API type
            const loadingSpan = document.querySelector('#loadingIndicator span');
            if (promptType === 'newprogram') {
                loadingSpan.textContent = `Generating ${buttonElement.textContent} with Claude AI...`;
            } else {
                loadingSpan.textContent = `Generating ${buttonElement.textContent} with Gemini AI...`;
            }
            
            // Generate summary with selected prompt
            generateSummary();
        }

        function generateSummary() {
            if (isProcessing) {
                return;
            }
            
            // Check if Tableau extension is initialized
            if (!isInitialized || !tableau || !tableau.extensions || !tableau.extensions.dashboardContent) {
                console.error('‚ö†Ô∏è Tableau extension not initialized yet');
                showError('Extension is still initializing. Please wait a moment and try again.');
                return;
            }
            
            if (!prompts[currentPromptType]) {
                showError(`${currentPromptType} prompt not loaded. Please refresh the page and try again.`);
                return;
            }
            
            isProcessing = true;
            
            document.getElementById('loadingIndicator').style.display = 'block';
            hideError();
            
            // Clear any cached data to force fresh extraction
            console.log('üîÑ Clearing cached data and extracting fresh data...');
            
            setTimeout(function() {
                if (isProcessing) {
                    isProcessing = false;
                    document.getElementById('loadingIndicator').style.display = 'none';
                    showError('Process timed out after 3 minutes. Please try again or select fewer institutions.');
                }
            }, 180000);
            
            // Determine which data extraction method to use
            let dataExtractionPromise;
            if (currentPromptType === 'newprogram') {
                // Claude uses metrics data
                dataExtractionPromise = extractClaudeData();
            } else {
                // Gemini uses institution data
                dataExtractionPromise = extractGeminiData();
            }
            
            dataExtractionPromise
                .then(function(data) {
                    console.log('‚úÖ Fresh data extracted:', data);
                    
                    // Call appropriate API
                    if (currentPromptType === 'newprogram') {
                        return callClaudeAPI(data);
                    } else {
                        return callGeminiAPI(data);
                    }
                })
                .then(function(summary) {
                    let htmlSummary;
                    if (currentPromptType === 'newprogram') {
                        htmlSummary = formatClaudeSummary(summary);
                    } else {
                        htmlSummary = formatGeminiSummary(summary);
                    }
                    document.getElementById('summaryText').innerHTML = htmlSummary;
                })
                .catch(function(error) {
                    console.error('‚ùå Failed:', error);
                    showError('Failed: ' + error.message);
                })
                .finally(function() {
                    isProcessing = false;
                    document.getElementById('loadingIndicator').style.display = 'none';
                });
        }

        // Extract data for Gemini (institutions)
        function extractGeminiData() {
            return new Promise(function(resolve, reject) {
                if (typeof tableau === 'undefined' || !tableau.extensions) {
                    reject(new Error('Tableau API not available'));
                    return;
                }

                try {
                    // Force fresh data extraction every time
                    console.log('üîÑ Extracting fresh Gemini data from Tableau...');
                    
                    const worksheets = tableau.extensions.dashboardContent.dashboard.worksheets;
                    console.log(`Found ${worksheets.length} worksheets for Gemini`);
                    
                    // Look for institution worksheets
                    let secondaryInstitutionsWs = worksheets.find(ws => 
                        ws.name.toLowerCase().includes('claude') && 
                        ws.name.toLowerCase().includes('secondary') &&
                        ws.name.toLowerCase().includes('institution')
                    );
                    
                    let tertiaryInstitutionsWs = worksheets.find(ws => 
                        ws.name.toLowerCase().includes('claude') && 
                        ws.name.toLowerCase().includes('tertiary') &&
                        ws.name.toLowerCase().includes('institution')
                    );

                    // Fallback to any worksheet with institution in name
                    if (!secondaryInstitutionsWs && !tertiaryInstitutionsWs) {
                        const anyInstitutionWs = worksheets.find(ws => 
                            ws.name.toLowerCase().includes('institution')
                        );
                        if (anyInstitutionWs) {
                            secondaryInstitutionsWs = anyInstitutionWs;
                        }
                    }

                    if (!secondaryInstitutionsWs && !tertiaryInstitutionsWs) {
                        reject(new Error('No institution worksheets found'));
                        return;
                    }

                    console.log(`Found secondary institutions: "${secondaryInstitutionsWs?.name || 'None'}"`);
                    console.log(`Found tertiary institutions: "${tertiaryInstitutionsWs?.name || 'None'}"`);

                    // Always get fresh data with getSummaryDataAsync
                    Promise.all([
                        secondaryInstitutionsWs ? secondaryInstitutionsWs.getSummaryDataAsync() : Promise.resolve(null),
                        tertiaryInstitutionsWs ? tertiaryInstitutionsWs.getSummaryDataAsync() : Promise.resolve(null)
                    ])
                    .then(function([secondaryData, tertiaryData]) {
                        let secondaryInstitutions = [];
                        let tertiaryInstitutions = [];
                        let selectedState = '';
                        
                        if (secondaryData) {
                            console.log(`Got ${secondaryData.data.length} secondary institution rows (fresh data)`);
                            secondaryInstitutions = extractInstitutionNames(secondaryData);
                            if (!selectedState) selectedState = extractSelectedState(secondaryData);
                        }
                        
                        if (tertiaryData) {
                            console.log(`Got ${tertiaryData.data.length} tertiary institution rows (fresh data)`);
                            tertiaryInstitutions = extractInstitutionNames(tertiaryData);
                            if (!selectedState) selectedState = extractSelectedState(tertiaryData);
                        }

                        // Extract program information
                        let currentProgram = 'Program Analysis';
                        
                        if (secondaryData && secondaryData.data.length > 0) {
                            currentProgram = extractProgramInfo(secondaryData);
                        } else if (tertiaryData && tertiaryData.data.length > 0) {
                            currentProgram = extractProgramInfo(tertiaryData);
                        }

                        resolve({
                            program: currentProgram,
                            secondaryInstitutions: secondaryInstitutions,
                            tertiaryInstitutions: tertiaryInstitutions,
                            selectedState: selectedState,
                            dataSource: 'Institution Data Analysis',
                            timestamp: new Date().toLocaleString()
                        });
                    })
                    .catch(function(error) {
                        console.error('Institution data extraction error:', error);
                        reject(new Error('Institution data extraction failed: ' + error.message));
                    });

                } catch (error) {
                    reject(error);
                }
            });
        }

        // Extract data for Claude (metrics)
        function extractClaudeData() {
            return new Promise(function(resolve, reject) {
                if (typeof tableau === 'undefined' || !tableau.extensions) {
                    reject(new Error('Tableau API not available'));
                    return;
                }

                try {
                    // Force fresh data extraction every time
                    console.log('üîÑ Extracting fresh Claude data from Tableau...');
                    
                    const worksheets = tableau.extensions.dashboardContent.dashboard.worksheets;
                    console.log(`Found ${worksheets.length} worksheets for Claude`);
                    
                    // Look for Claude metrics worksheet
                    let metricsWs = worksheets.find(ws => 
                        ws.name.toLowerCase().includes('claude') && 
                        ws.name.toLowerCase().includes('metrics') &&
                        ws.name.toLowerCase().includes('selected')
                    );
                    
                    // Fallback to any metrics worksheet
                    if (!metricsWs) {
                        metricsWs = worksheets.find(ws => 
                            ws.name.toLowerCase().includes('claude') && 
                            ws.name.toLowerCase().includes('metrics')
                        );
                    }
                    
                    // Look for institution worksheets (optional for Claude)
                    let secondaryInstitutionsWs = worksheets.find(ws => 
                        ws.name.toLowerCase().includes('claude') && 
                        ws.name.toLowerCase().includes('secondary') &&
                        ws.name.toLowerCase().includes('institution')
                    );
                    
                    let tertiaryInstitutionsWs = worksheets.find(ws => 
                        ws.name.toLowerCase().includes('claude') && 
                        ws.name.toLowerCase().includes('tertiary') &&
                        ws.name.toLowerCase().includes('institution')
                    );
                    
                    if (!metricsWs && worksheets.length > 0) {
                        metricsWs = worksheets[0];
                    }
                    
                    if (!metricsWs) {
                        reject(new Error('No metrics worksheet found'));
                        return;
                    }
                    
                    console.log(`Using metrics worksheet: "${metricsWs.name}"`);
                    
                    // Always get fresh data with getSummaryDataAsync
                    Promise.all([
                        metricsWs.getSummaryDataAsync(),
                        secondaryInstitutionsWs ? secondaryInstitutionsWs.getSummaryDataAsync() : Promise.resolve(null),
                        tertiaryInstitutionsWs ? tertiaryInstitutionsWs.getSummaryDataAsync() : Promise.resolve(null)
                    ])
                    .then(function([metricsData, secondaryData, tertiaryData]) {
                        console.log('üìä Fresh metrics data received');
                        const processedData = processMetricsData(metricsData);
                        
                        if (secondaryData) {
                            processedData.secondaryInstitutions = extractInstitutionNames(secondaryData);
                        }
                        
                        if (tertiaryData) {
                            processedData.tertiaryInstitutions = extractInstitutionNames(tertiaryData);
                        }
                        
                        resolve(processedData);
                    })
                    .catch(reject);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        function processMetricsData(dataTable) {
            const columns = dataTable.columns.map(col => col.fieldName);
            const rows = dataTable.data;
            
            console.log('Metrics columns:', columns);
            console.log('Metrics rows:', rows.length);
            
            const metrics = [];
            
            const measureValuesIndex = columns.findIndex(col => 
                col.toLowerCase().includes('measure values') || 
                col.toLowerCase().includes('values')
            );
            
            const measureNamesIndex = columns.findIndex(col => 
                col.toLowerCase().includes('measure names') || 
                col.toLowerCase().includes('names')
            );
            
            if (measureValuesIndex >= 0 && measureNamesIndex >= 0) {
                rows.forEach(function(row) {
                    let measureName = null;
                    let measureValue = null;
                    
                    if (row[measureNamesIndex]) {
                        const nameCell = row[measureNamesIndex];
                        measureName = nameCell._formattedValue || nameCell.value || 
                                    (typeof nameCell === 'object' && nameCell.value !== undefined ? nameCell.value : nameCell);
                    }
                    
                    if (row[measureValuesIndex]) {
                        const valueCell = row[measureValuesIndex];
                        measureValue = valueCell._value || valueCell.value || 
                                     (typeof valueCell === 'object' && valueCell.value !== undefined ? valueCell.value : valueCell);
                    }
                    
                    if (measureName && typeof measureValue === 'number') {
                        const cleanName = measureName.trim();
                        
                        if (!metrics.some(m => m.name === cleanName)) {
                            console.log(`‚úÖ Found measure: ${cleanName} = ${measureValue}`);
                            metrics.push({
                                name: cleanName,
                                value: measureValue
                            });
                        }
                    }
                });
            }
            
            // Extract program and job information
            let currentProgram = '11.0701 | Computer Science | Bachelor\'s';
            let currentJob = 'Software Developers';
            
            if (rows.length > 0) {
                const firstRow = rows[0];
                
                if (firstRow[0]) {
                    const cipValue = (typeof firstRow[0] === 'object' && firstRow[0].value !== undefined) 
                        ? firstRow[0].value : firstRow[0];
                    if (cipValue && cipValue !== '%null%') {
                        currentProgram = cipValue;
                    }
                }
                
                if (firstRow[1]) {
                    const jobValue = (typeof firstRow[1] === 'object' && firstRow[1].value !== undefined) 
                        ? firstRow[1].value : firstRow[1];
                    if (jobValue && jobValue !== '%null%') {
                        currentJob = jobValue;
                    }
                }
            }
            
            return {
                program: currentProgram,
                jobTarget: currentJob,
                metrics: metrics,
                dataSource: 'Claude Metrics Analysis',
                recordCount: rows.length,
                timestamp: new Date().toLocaleString()
            };
        }

        function extractProgramInfo(dataTable) {
            const columns = dataTable.columns.map(col => col.fieldName);
            const firstRow = dataTable.data[0];
            
            if (!firstRow) return 'Program Analysis';
            
            const cipIndex = columns.findIndex(col => 
                col.toLowerCase().includes('cip') || 
                col.toLowerCase().includes('award') ||
                col.toLowerCase().includes('program')
            );
            
            if (cipIndex >= 0 && firstRow[cipIndex]) {
                const cipValue = (typeof firstRow[cipIndex] === 'object' && firstRow[cipIndex].value !== undefined) 
                    ? firstRow[cipIndex].value : firstRow[cipIndex];
                if (cipValue && cipValue !== '%null%') {
                    console.log('üìä Current program:', cipValue);
                    return cipValue;
                }
            }
            
            return 'Program Analysis';
        }

        function extractSelectedState(dataTable) {
            console.log('üîç Debugging state extraction...');
            const columns = dataTable.columns.map(col => col.fieldName);
            const firstRow = dataTable.data[0];
            
            console.log('Available columns:', columns);
            console.log('First row data:', firstRow);
            
            if (!firstRow) {
                console.log('‚ùå No first row found');
                return '';
            }
            
            // Look for state column with more variations
            const stateIndex = columns.findIndex(col => {
                const colLower = col.toLowerCase();
                return colLower.includes('state') ||
                       colLower.includes('st ') ||
                       colLower.includes(' st') ||
                       colLower === 'st' ||
                       colLower.includes('location') ||
                       colLower.includes('region');
            });
            
            console.log('State column index:', stateIndex);
            if (stateIndex >= 0) {
                console.log('State column name:', columns[stateIndex]);
                console.log('State column raw value:', firstRow[stateIndex]);
            }
            
            if (stateIndex >= 0 && firstRow[stateIndex]) {
                let stateValue = firstRow[stateIndex];
                
                // Handle different object structures
                if (typeof stateValue === 'object') {
                    console.log('State value is object:', stateValue);
                    if (stateValue._formattedValue) {
                        stateValue = stateValue._formattedValue;
                    } else if (stateValue._value) {
                        stateValue = stateValue._value;
                    } else if (stateValue.value !== undefined) {
                        stateValue = stateValue.value;
                    } else if (stateValue.formattedValue) {
                        stateValue = stateValue.formattedValue;
                    }
                }
                
                console.log('Processed state value:', stateValue);
                
                if (stateValue && stateValue !== '%null%' && stateValue.toString().trim() !== '') {
                    const finalState = stateValue.toString().trim();
                    console.log('‚úÖ Final selected state:', finalState);
                    return finalState;
                }
            }
            
            console.log('‚ùå No valid state found');
            return '';
        }

        function extractInstitutionNames(dataTable) {
            const columns = dataTable.columns.map(col => col.fieldName);
            const rows = dataTable.data;
            
            console.log('Institution table columns:', columns);
            
            let institutionColumnIndex = columns.findIndex(col => 
                col.toLowerCase() === 'institution'
            );
            
            if (institutionColumnIndex === -1) {
                institutionColumnIndex = columns.findIndex(col => 
                    col.toLowerCase().includes('institution') ||
                    col.toLowerCase().includes('school') ||
                    col.toLowerCase().includes('university') ||
                    col.toLowerCase().includes('college')
                );
                
                if (institutionColumnIndex === -1) {
                    console.log('‚ö†Ô∏è No institution column found');
                    return [];
                }
            }
            
            console.log(`Found institution column at index ${institutionColumnIndex}: "${columns[institutionColumnIndex]}"`);
            
            const institutions = [];
            
            rows.forEach(function(row) {
                if (row[institutionColumnIndex]) {
                    let institutionName = row[institutionColumnIndex];
                    
                    if (typeof institutionName === 'object' && institutionName._formattedValue) {
                        institutionName = institutionName._formattedValue;
                    } else if (typeof institutionName === 'object' && institutionName._value) {
                        institutionName = institutionName._value;
                    } else if (typeof institutionName === 'object' && institutionName.value !== undefined) {
                        institutionName = institutionName.value;
                    }
                    
                    if (institutionName && typeof institutionName === 'string' && institutionName.trim() !== '') {
                        const cleanName = institutionName.trim();
                        if (!institutions.includes(cleanName) && !cleanName.includes('|')) {
                            institutions.push(cleanName);
                        }
                    }
                }
            });
            
            console.log(`Extracted ${institutions.length} unique institutions`);
            return institutions;
        }

        function callGeminiAPI(data) {
            let institutionList = [];
            
            if (data.secondaryInstitutions) {
                institutionList = institutionList.concat(data.secondaryInstitutions);
            }
            if (data.tertiaryInstitutions) {
                institutionList = institutionList.concat(data.tertiaryInstitutions);
            }
            
            // Remove duplicates and limit to 20
            institutionList = [...new Set(institutionList)].slice(0, 20);
            
            const prompt = prompts[currentPromptType]
                .replace(/\[Program\]/g, data.program)
                .replace(/\[List of institutions\]/g, institutionList.join(', '))
                .replace(/\[Selected Institution State\]/g, data.selectedState || 'Not specified');
            
            console.log('üöÄ Sending', currentPromptType, 'prompt to Gemini API...');
            console.log('üìã Analyzing institutions:', institutionList.length);

            return fetch(GEMINI_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            })
            .then(function(response) {
                if (!response.ok) throw new Error('Gemini API error: ' + response.status);
                return response.json();
            })
            .then(function(result) {
                if (result && result.success) {
                    return result.content;
                } else {
                    throw new Error(result?.error || 'Gemini API returned error');
                }
            });
        }

        function callClaudeAPI(data) {
            let institutionText = '';
            if (data.secondaryInstitutions && data.secondaryInstitutions.length > 0) {
                institutionText += `\n\nTOP INSTITUTIONS (SECONDARY MARKET):\n${data.secondaryInstitutions.slice(0, 10).map((inst, i) => `${i + 1}. ${inst}`).join('\n')}`;
            }
            if (data.tertiaryInstitutions && data.tertiaryInstitutions.length > 0) {
                institutionText += `\n\nTOP INSTITUTIONS (TERTIARY MARKET):\n${data.tertiaryInstitutions.slice(0, 10).map((inst, i) => `${i + 1}. ${inst}`).join('\n')}`;
            }
            
            const prompt = prompts.newprogram
                .replace(/\{\{PROGRAM\}\}/g, data.program)
                .replace(/\{\{JOB_TARGET\}\}/g, data.jobTarget)
                .replace(/\{\{TIMESTAMP\}\}/g, data.timestamp)
                .replace(/\{\{DATA_SOURCE\}\}/g, data.dataSource)
                .replace(/\{\{METRICS\}\}/g, data.metrics.map(m => `‚Ä¢ ${m.name}: ${m.value}`).join('\n'))
                .replace(/\{\{INSTITUTIONS\}\}/g, institutionText);
            
            console.log('üöÄ Sending prompt to Claude API...');

            return fetch(CLAUDE_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            })
            .then(function(response) {
                if (!response.ok) throw new Error('Claude API error: ' + response.status);
                return response.json();
            })
            .then(function(result) {
                if (result && result.success) {
                    return result.content;
                } else {
                    throw new Error(result?.error || 'Claude API returned error');
                }
            });
        }

        function formatGeminiSummary(summary) {
            let htmlSummary = summary
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^\*\*(.*?)\*\*$/gm, '<h2>$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            if (!htmlSummary.includes('<p>')) {
                htmlSummary = '<p>' + htmlSummary + '</p>';
            }
            
            // Apply Gemini-specific subtitle styling
            let lines = htmlSummary.split('<br>');
            if (lines.length > 0 && lines[0] && !lines[0].includes('<h2>') && !lines[0].includes('<h3>')) {
                lines[0] = `<span class="subtitle">${lines[0]}</span>`;
            }
            htmlSummary = lines.join('<br>');
            
            return htmlSummary;
        }

        function formatClaudeSummary(summary) {
            let htmlSummary = summary
                .replace(/^(?:\*\*)?([A-Z][^:.\n]+(?::|$))(?:\*\*)?$/gm, '<h2>$1</h2>')
                .replace(/^(Why we like it|Potential concerns|Overall assessment)[:]*$/gmi, '<h2>$1</h2>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^\*\*(.*?)\*\*$/gm, '<h2>$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>')
                .replace(/<h2>([^<]+):<\/h2>/g, '<h2>$1</h2>');
            
            let lines = htmlSummary.split('<br>');
            
            lines = lines.filter(line => {
                const cleanLine = line.replace(/<[^>]*>/g, '').trim().toUpperCase();
                return !(cleanLine === 'MARKET OUTLOOK SUMMARY' || 
                        cleanLine === 'MARKET OUTLOOK' ||
                        cleanLine === 'SUMMARY' ||
                        cleanLine === '');
            });
            
            if (lines.length > 0 && lines[0] && !lines[0].includes('<h2>')) {
                lines[0] = `<span style="color: #1AB2D7 !important; font-size: 18px; display: block;">${lines[0]}</span>`;
            }
            
            htmlSummary = lines.join('<br>');
            
            if (!htmlSummary.includes('<p>')) {
                htmlSummary = '<p>' + htmlSummary + '</p>';
            }
            
            // Handle metrics table if present
            if (htmlSummary.includes('Category | Score')) {
                htmlSummary = convertMetricsTable(htmlSummary);
            }
            
            return htmlSummary;
        }

        function convertMetricsTable(htmlSummary) {
            return htmlSummary.replace(
                /Category \| Score[\s\S]*?Total Score[^|]*\|[^0-9]*([\d.]+)/,
                function(match) {
                    const lines = match.split(/\n|<br>/);
                    let tableHTML = '<table><thead><tr><th>Category</th><th>Score</th></tr></thead><tbody>';
                    
                    lines.forEach(line => {
                        if (line.includes('Category | Score') || line.includes('---') || !line.trim()) {
                            return;
                        }
                        
                        if (line.includes('Total Score')) {
                            const totalMatch = line.match(/Total Score[^|]*\|[^0-9]*([\d.]+)/);
                            if (totalMatch) {
                                const formattedTotalScore = parseFloat(totalMatch[1]).toFixed(1);
                                tableHTML += `<tr><td><strong>Total Score (Max 10)</strong></td><td><strong>${formattedTotalScore}</strong></td></tr>`;
                            }
                        } else if (line.includes('|')) {
                            const parts = line.split('|');
                            if (parts.length >= 2) {
                                const category = parts[0].trim();
                                const scoreText = parts[1].trim();
                                const scoreMatch = scoreText.match(/([\d.]+)/);
                                if (scoreMatch) {
                                    const score = parseFloat(scoreMatch[1]).toFixed(1);
                                    tableHTML += `<tr><td>${category}</td><td>${score}</td></tr>`;
                                }
                            }
                        }
                    });
                    
                    tableHTML += '</tbody></table>';
                    return tableHTML;
                }
            );
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>
